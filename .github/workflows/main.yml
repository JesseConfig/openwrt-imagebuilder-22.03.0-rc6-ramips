name: make_image
on:
  push:
    branches: 
      #将工作流设置为在将事件推送到main和main/*分支时运行
     - main
      #  schedule:
      #    - cron: 0 20 * * *
      #  release:
      #    types: [published]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          ref: main	  
      - name: Initialization environment
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          docker rmi `docker images -q`
		  
          #echo "Deleting files, please wait ..."
          #sudo rm -rf /usr/share/dotnet /etc/mysql /etc/php
          #sudo -E apt-get -y purge azure-cli ghc* zulu* hhvm llvm* firefox google* dotnet* powershell openjdk* mysql* php*
          #sudo -E apt-get update
          #sudo -E apt-get -y install build-essential asciidoc binutils bzip2 gawk gettext git libncurses5-dev libz-dev patch unzip zlib1g-dev lib32gcc1 libc6-dev-i386 subversion flex uglifyjs git-core gcc-multilib p7zip p7zip-full msmtp libssl-dev texinfo libglib2.0-dev xmlto qemu-utils upx libelf-dev autoconf automake libtool autopoint device-tree-compiler
          #sudo -E apt-get -y autoremove --purge
          #sudo -E apt-get clean
      - name: make_image
        run: |
          pwd
          chmod +x make*
          ./make_xiaoyu
          ./make_y1
          echo "Builder OK"
      - name: Assemble Builder_bin
        run: |
          TM=`date +%Y-%m-%d-%H`
          echo $TM
          rm -rf ./Builder_bin/
          mkdir -p ./Builder_bin/
          find ./ -name "*sysupgrade*bin*" | xargs -i mv -f {} ./Builder_bin/
      - name: Upload Builder_bin
        uses: actions/upload-artifact@v2
        with:
          name: openwrt-imagebuilder-22.03.0-rc6_firmware
          path: ./Builder_bin/
